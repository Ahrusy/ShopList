# Парсинг товаров с Ozon в PostgreSQL

Этот набор скриптов позволяет спарсить 500 реальных товаров с маркетплейса Ozon и загрузить их в базу данных PostgreSQL с полной иерархией категорий, характеристиками и изображениями.

## Структура проекта

- `setup_postgres.py` - Настройка PostgreSQL и выполнение миграций
- `scrape_ozon_products_postgres.py` - Основной скрипт парсинга товаров
- `run_parsing.py` - Главный скрипт для запуска всего процесса
- `check_results.py` - Проверка результатов парсинга

## Требования

### Системные требования
- Python 3.8+
- PostgreSQL 12+
- Chrome/Chromium браузер
- ChromeDriver

### Python зависимости
```bash
pip install -r requirements.txt
```

## Настройка

### 1. Настройка PostgreSQL

Убедитесь, что PostgreSQL запущен и доступен. В файле `shoplist/settings.py` проверьте настройки подключения:

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'shoplist_db',
        'USER': 'postgres',
        'PASSWORD': 'postgres',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

### 2. Установка зависимостей

```bash
pip install django psycopg2-binary requests beautifulsoup4 selenium webdriver-manager
```

## Запуск

### Автоматический запуск (рекомендуется)

```bash
python run_parsing.py
```

Этот скрипт автоматически:
1. Проверит зависимости
2. Настроит PostgreSQL
3. Выполнит миграции
4. Запустит парсинг товаров

### Ручной запуск

1. **Настройка PostgreSQL:**
```bash
python setup_postgres.py
```

2. **Парсинг товаров:**
```bash
python scrape_ozon_products_postgres.py
```

3. **Проверка результатов:**
```bash
python check_results.py
```

## Что парсится

### Категории (3 уровня)
- **1 уровень**: Электроника, Одежда и обувь, Дом и сад, Красота и здоровье, Детские товары
- **2 уровень**: Смартфоны, Ноутбуки, Телевизоры, Планшеты, Женская одежда, Мужская одежда, Обувь, Мебель, Бытовая техника, Косметика, Уход за волосами, Одежда для детей, Игрушки
- **3 уровень**: iPhone, Samsung, Xiaomi, Игровые ноутбуки, Ультрабуки, MacBook, 4K телевизоры, Smart TV, OLED телевизоры, iPad, Android планшеты, Платья, Блузки, Джинсы, Рубашки, Футболки, Кроссовки, Туфли, Сапоги, Диваны, Кровати, Столы, Холодильники, Стиральные машины, Пылесосы, Декоративная косметика, Уход за кожей, Парфюмерия, Шампуни, Маски для волос, Для мальчиков, Для девочек, Конструкторы, Куклы

### Данные товаров
- Название товара
- Описание
- Цена
- Технические характеристики
- Изображения (до 5 штук)
- Рейтинг и количество отзывов
- Количество на складе

## Структура базы данных

### Основные таблицы
- `products_product` - Товары
- `products_category` - Категории (с иерархией)
- `products_productcharacteristic` - Характеристики товаров
- `products_productimage` - Изображения товаров
- `products_seller` - Продавцы

### Связи
- Товар → Категория (3-й уровень)
- Товар → Продавец
- Товар → Характеристики (1:N)
- Товар → Изображения (1:N)
- Категория → Подкатегории (1:N)

## Логирование

Все скрипты создают подробные логи:
- `setup_postgres.log` - Логи настройки PostgreSQL
- `scrape_ozon_products_postgres.log` - Логи парсинга
- `run_parsing.log` - Логи главного скрипта
- `check_results.log` - Логи проверки результатов

## Обработка ошибок

Скрипты включают:
- Повторные попытки при ошибках сети
- Обработку таймаутов
- Валидацию данных
- Детальное логирование ошибок

## Производительность

- Парсинг 500 товаров занимает ~2-3 часа
- Случайные задержки между запросами (2-5 секунд)
- Ограничение на количество товаров из каждой категории
- Параллельная обработка изображений

## Безопасность

- Использование User-Agent заголовков
- Обработка SSL сертификатов
- Валидация URL изображений
- Ограничение размера загружаемых файлов

## Мониторинг

Скрипт `check_results.py` предоставляет:
- Общую статистику базы данных
- Иерархию категорий
- Распределение товаров по категориям
- Детали товаров
- Проверку здоровья базы данных

## Устранение неполадок

### Ошибки подключения к PostgreSQL
1. Проверьте, что PostgreSQL запущен
2. Проверьте настройки в `settings.py`
3. Убедитесь, что пользователь `postgres` существует

### Ошибки парсинга
1. Проверьте интернет-соединение
2. Убедитесь, что Chrome/Chromium установлен
3. Проверьте логи на наличие ошибок

### Ошибки загрузки изображений
1. Проверьте доступность URL изображений
2. Убедитесь, что есть свободное место на диске
3. Проверьте права доступа к папке `media/`

## Результат

После успешного выполнения вы получите:
- 500+ товаров с полными данными
- 3-уровневую иерархию категорий
- Технические характеристики для каждого товара
- Изображения товаров
- Готовую базу данных для работы маркетплейса
