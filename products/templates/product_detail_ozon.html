{% extends 'base_ozon.html' %}

{% block title %}{{ product.name }} - ShopList{% endblock %}

{% block content %}
<div class="bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumbs -->
        <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-6">
            <a href="/" class="hover:text-blue-600">Главная</a>
            <i class="fas fa-chevron-right text-xs"></i>
            <a href="?category={{ product.category.id }}" class="hover:text-blue-600">{{ product.category.name }}</a>
            <i class="fas fa-chevron-right text-xs"></i>
            <span class="text-gray-900">{{ product.name|truncatechars:50 }}</span>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Product Images -->
            <div class="space-y-4">
                <!-- Main Image -->
                <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer">
                    {% if product.images.first %}
                        <img src="{{ product.images.first.image.url }}" 
                             alt="{{ product.name }}" 
                             class="main-image w-full h-full object-cover hover:scale-105 transition-transform duration-300">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center">
                            <i class="fas fa-image text-gray-400 text-6xl"></i>
                        </div>
                    {% endif %}
                </div>

                <!-- Thumbnail Images -->
                {% if product.images.count > 1 %}
                <div class="grid grid-cols-4 gap-2">
                    {% for image in product.images.all|slice:":4" %}
                    <div class="thumbnail aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all">
                        <img src="{{ image.image.url }}" 
                             alt="{{ product.name }}" 
                             class="w-full h-full object-cover">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- PhotoSwipe Gallery (hidden) -->
                <div class="product-gallery" style="display: none;">
                    {% for image in product.images.all %}
                    <a href="{{ image.image.url }}" 
                       data-pswp-width="1200" 
                       data-pswp-height="1200" 
                       target="_blank">
                        <img src="{{ image.image.url }}" 
                             alt="{{ product.name }}" 
                             style="display: none;">
                    </a>
                    {% endfor %}
                </div>
            </div>

            <!-- Product Info -->
            <div class="space-y-6">
                <!-- Rating and Reviews -->
                <div class="flex items-center space-x-4">
                    <div class="flex rating-stars">
                        {% for i in "12345" %}
                            {% if forloop.counter <= product.rating %}
                                <i class="fas fa-star"></i>
                            {% else %}
                                <i class="far fa-star"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="text-gray-600">{{ product.rating|floatformat:1 }}</span>
                    <span class="text-gray-500">({{ product.reviews_count }} отзывов)</span>
                </div>

                <!-- Product Name -->
                <h1 class="text-3xl font-bold text-gray-900">{{ product.name }}</h1>

                <!-- Seller -->
                <div class="flex items-center space-x-2">
                    <span class="text-gray-600">Продавец:</span>
                    <a href="#" class="text-blue-600 hover:text-blue-800 font-medium">{{ product.seller.company_name }}</a>
                    {% if product.seller.is_verified %}
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">✓ Проверенный</span>
                    {% endif %}
                </div>

                <!-- Price -->
                <div class="space-y-2">
                    {% if product.discount_price %}
                        <div class="flex items-center space-x-4">
                            <span class="price-current text-4xl font-bold">{{ product.discount_price|floatformat:0 }} ₽</span>
                            <span class="price-old text-2xl">{{ product.price|floatformat:0 }} ₽</span>
                            <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold">
                                -{{ product.discount_percent|floatformat:0 }}%
                            </span>
                        </div>
                    {% else %}
                        <span class="price-current text-4xl font-bold">{{ product.price|floatformat:0 }} ₽</span>
                    {% endif %}
                </div>

                <!-- Stock Status -->
                <div class="flex items-center space-x-2">
                    {% if product.stock_quantity > 0 %}
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="text-green-600 font-medium">В наличии ({{ product.stock_quantity }} шт.)</span>
                    {% else %}
                        <i class="fas fa-times-circle text-red-500"></i>
                        <span class="text-red-600 font-medium">Нет в наличии</span>
                    {% endif %}
                </div>

                <!-- Quantity and Add to Cart -->
                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="text-gray-700 font-medium">Количество:</label>
                        <div class="flex items-center border border-gray-300 rounded-lg">
                            <button onclick="changeQuantity(-1)" class="px-3 py-2 hover:bg-gray-100">-</button>
                            <input type="number" id="quantity" value="1" min="1" max="{{ product.stock_quantity }}" 
                                   class="w-16 text-center border-0 focus:outline-none">
                            <button onclick="changeQuantity(1)" class="px-3 py-2 hover:bg-gray-100">+</button>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="addToCart({{ product.id }}, parseInt(document.getElementById('quantity').value))" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-4 px-6 rounded-lg font-semibold text-lg transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                {% if product.stock_quantity == 0 %}disabled{% endif %}>
                            {% if product.stock_quantity > 0 %}
                                <i class="fas fa-shopping-cart mr-2"></i>Добавить в корзину
                            {% else %}
                                Нет в наличии
                            {% endif %}
                        </button>
                        <button class="w-12 h-12 border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-50">
                            <i class="fas fa-heart text-gray-400"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Product Description and Characteristics -->
        <div class="mt-12 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Description -->
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Описание</h2>
                <div class="prose max-w-none text-gray-600">
                    {{ product.description|linebreaks }}
                </div>
            </div>

            <!-- Characteristics -->
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Характеристики</h2>
                <div class="space-y-3">
                    {% for char in product.characteristics.all %}
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="text-gray-600">{{ char.name }}</span>
                        <span class="text-gray-900 font-medium">{{ char.value }}</span>
                    </div>
                    {% empty %}
                    <p class="text-gray-500">Характеристики не указаны</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="mt-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Отзывы ({{ product.reviews_count }})</h2>
            
            {% if product.reviews.all %}
                <div class="space-y-6">
                    {% for review in product.reviews.all|slice:":5" %}
                    <div class="bg-gray-50 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-900">{{ review.user.first_name|default:"Покупатель" }}</h4>
                                    <div class="flex rating-stars">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= review.rating %}
                                                <i class="fas fa-star text-sm"></i>
                                            {% else %}
                                                <i class="far fa-star text-sm"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <span class="text-sm text-gray-500">{{ review.created_at|date:"d.m.Y" }}</span>
                        </div>
                        <p class="text-gray-700">{{ review.comment }}</p>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-comments text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Пока нет отзывов</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function changeQuantity(delta) {
    const input = document.getElementById('quantity');
    const currentValue = parseInt(input.value);
    const newValue = Math.max(1, Math.min({{ product.stock_quantity }}, currentValue + delta));
    input.value = newValue;
}
</script>

<!-- PhotoSwipe CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.2/dist/photoswipe.css">

<!-- PhotoSwipe JS -->
<script src="https://cdn.jsdelivr.net/npm/photoswipe@5.4.2/dist/photoswipe.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@5.4.2/dist/photoswipe-lightbox.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация PhotoSwipe для галереи изображений
    const gallery = document.querySelector('.product-gallery');
    if (gallery) {
        const lightbox = new PhotoSwipeLightbox({
            gallery: '.product-gallery',
            children: 'a',
            showHideOpacity: true,
            bgOpacity: 0.8,
            spacing: 0.1,
            allowPanToNext: false,
            loop: false,
            preload: [1, 2],
            pswpModule: PhotoSwipe
        });
        
        lightbox.init();
    }
    
    // Обработка клика на миниатюры
    const thumbnails = document.querySelectorAll('.thumbnail');
    thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', function(e) {
            e.preventDefault();
            const mainImage = document.querySelector('.main-image');
            const img = this.querySelector('img');
            if (mainImage && img) {
                mainImage.src = img.src;
                mainImage.alt = img.alt;
            }
        });
    });
    
    // Обработка клика на главное изображение
    const mainImage = document.querySelector('.main-image');
    if (mainImage) {
        mainImage.addEventListener('click', function() {
            const firstGalleryLink = document.querySelector('.product-gallery a');
            if (firstGalleryLink) {
                firstGalleryLink.click();
            }
        });
    }
});
</script>
{% endblock %}