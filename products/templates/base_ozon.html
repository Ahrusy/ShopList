{% load static %} {% load i18n %}
<!DOCTYPE html>
<html
  lang="{% get_current_language as LANGUAGE_CODE %}{{ LANGUAGE_CODE|default:'ru' }}"
  dir="{% if LANGUAGE_CODE == 'ar' %}rtl{% else %}ltr{% endif %}"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{% csrf_token %}" />
    {% csrf_token %}
    <title>{% block title %}ShopList - Интернет-магазин{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Swiper CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />

    <!-- Alpine.js -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    {% block extra_head %}{% endblock %}

    <style>
      .max-w-8xl {
        max-width: 88rem; /* 1408px */
      }

      .ozon-gradient {
        background: linear-gradient(135deg, #005bff 0%, #00a8ff 100%);
      }
      .ozon-orange {
        background: #ff6b35;
      }
      .ozon-blue {
        background: #005bff;
      }

      /* Градиентные фоны для элементов интерфейса */
      .topbar-gradient {
        background: linear-gradient(
          135deg,
          #e2e8f0 0%,
          #cbd5e1 100%
        ) !important;
      }
      .header-gradient {
        background: linear-gradient(
          135deg,
          #f1f5f9 0%,
          #e2e8f0 100%
        ) !important;
      }

      /* Enhanced 3-Level Mega Menu Styles */
      .mega-menu-container {
        transition: all 0.3s ease;
        backdrop-filter: blur(8px);
      }

      .mega-menu-sidebar {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      }

      .mega-menu-level2 {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      }

      .mega-menu-content {
        background: #ffffff;
      }

      /* Category placeholder styling */
      .category-placeholder {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      /* Enhanced hover effects */
      .catalog-category-link:hover .category-placeholder {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        transform: scale(1.05);
      }

      .catalog-category-link:hover .category-placeholder i {
        color: white !important;
      }

      /* Level 2 category styling */
      .level2-category-item {
        transition: all 0.2s ease;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
      }

      .level2-category-item:hover {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-color: #3b82f6;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      }

      /* Level 3 category cards */
      .level3-category-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
        background: #ffffff;
        border: 1px solid #e5e7eb;
      }

      .level3-category-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        border-color: #3b82f6;
      }

      .level3-category-card .category-image {
        transition: transform 0.3s ease;
      }

      .level3-category-card:hover .category-image {
        transform: scale(1.05);
      }

      /* Image placeholder for categories without images */
      .category-image-placeholder {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .category-image-placeholder::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      /* Responsive design for mobile devices */
      @media (max-width: 1023px) {
        .mega-menu-container {
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          bottom: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          max-width: none !important;
          border-radius: 0 !important;
          z-index: 9999 !important;
        }

        .mega-menu-container .flex {
          height: 100vh !important;
          flex-direction: column;
        }

        .mega-menu-sidebar {
          width: 100% !important;
          height: auto !important;
          max-height: 40vh;
          border-right: none;
          border-bottom: 1px solid #e5e7eb;
        }

        .mega-menu-content {
          flex: 1;
          height: auto !important;
        }

        .mega-menu-level2 {
          display: none !important;
        }
      }

      @media (max-width: 767px) {
        .mega-menu-container .p-6 {
          padding: 1rem !important;
        }

        .mega-menu-container .p-8 {
          padding: 1rem !important;
        }

        .mega-menu-sidebar .p-4 {
          padding: 1rem !important;
        }

        /* Mobile-specific category grid */
        .mobile-category-grid {
          grid-template-columns: 1fr !important;
          gap: 1rem !important;
        }

        .level3-category-card {
          margin-bottom: 1rem;
        }
      }

      /* Loading states */
      .loading-skeleton {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* Search suggestions styling */
      #searchSuggestions {
        z-index: 70;
      }

      .search-suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .search-suggestion-item:hover {
        background-color: #f3f4f6;
      }

      .search-suggestion-item.active {
        background-color: #eff6ff;
        color: #1d4ed8;
      }

      /* Breadcrumb styling */
      #categoryBreadcrumbs ol {
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      #categoryBreadcrumbs li {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* View toggle buttons */
      #viewToggle button.active {
        background-color: #3b82f6;
        color: white;
      }

      /* Accessibility improvements */
      .catalog-category-link:focus {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
      }

      .level2-category-item:focus {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
      }

      /* Animation for menu opening/closing */
      .mega-menu-container.opening {
        animation: menuSlideIn 0.3s ease-out;
      }

      .mega-menu-container.closing {
        animation: menuSlideOut 0.3s ease-in;
      }

      @keyframes menuSlideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes menuSlideOut {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      /* Prevent body scroll when mega menu is open on mobile */
      body.mega-menu-open {
        overflow: hidden;
      }

      /* Enhanced category count badges */
      .category-count-badge {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border: 1px solid #d1d5db;
        font-size: 0.75rem;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 12px;
        transition: all 0.2s ease;
      }

      .catalog-category-link:hover .category-count-badge {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-color: #3b82f6;
        color: #1d4ed8;
      }

      /* Product preview cards in level 3 */
      .product-preview-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        transition: all 0.2s ease;
      }

      .product-preview-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      }

      /* Featured products section */
      .featured-products-section {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 12px;
        padding: 16px;
        margin-top: 24px;
      }

      /* Error and empty states */
      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6b7280;
      }

      .error-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #ef4444;
      }

      /* Smooth transitions for all interactive elements */
      * {
        transition-property: color, background-color, border-color, transform,
          box-shadow;
        transition-duration: 0.2s;
        transition-timing-function: ease;
      }

      /* Line clamp utilities for text truncation */
      .line-clamp-1 {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* Aspect ratio utilities */
      .aspect-w-16 {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
      }

      .aspect-w-16 > * {
        position: absolute;
        height: 100%;
        width: 100%;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      .aspect-w-1 {
        position: relative;
        padding-bottom: 100%; /* 1:1 aspect ratio */
      }

      .aspect-w-1 > * {
        position: absolute;
        height: 100%;
        width: 100%;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      /* Enhanced focus styles for accessibility */
      .catalog-category-link:focus-visible,
      .level2-category-item:focus-visible,
      .level3-category-card:focus-visible {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
        border-radius: 8px;
      }

      /* High contrast mode support */
      @media (prefers-contrast: high) {
        .category-placeholder {
          border: 2px solid currentColor;
        }

        .level3-category-card {
          border: 2px solid currentColor;
        }
      }

      /* Reduced motion support */
      @media (prefers-reduced-motion: reduce) {
        .mega-menu-container,
        .catalog-category-link,
        .level2-category-item,
        .level3-category-card,
        .category-image {
          transition: none !important;
          animation: none !important;
        }

        .category-image-placeholder::before {
          animation: none !important;
        }
      }

      /* Print styles */
      @media print {
        .mega-menu-container {
          display: none !important;
        }
      }
      .footer-gradient {
        background: linear-gradient(
          135deg,
          #374151 0%,
          #1f2937 100%
        ) !important;
      }
      .product-card {
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
        width: 270px;
        min-height: 450px;
      }
      .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border-color: #005bff;
      }

      /* Product grid adjustments */
      #products-grid {
        grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)) !important;
        gap: 20px !important;
      }

      /* Related products flexbox spacing */
      .flex.flex-wrap.gap-6 {
        gap: 1.5rem !important;
      }

      /* Ensure product cards maintain their fixed width */
      .product-card {
        flex-shrink: 0 !important;
        margin-bottom: 0 !important;
      }

      /* Product card content visibility - максимальный приоритет */
      .product-card p[style*="color: #2563eb"] {
        color: #2563eb !important;
        font-weight: 600 !important;
        font-size: 12px !important;
      }

      .product-card .rating-stars {
        color: #fbbf24 !important;
      }

      .product-card .rating-stars i {
        color: #fbbf24 !important;
        font-size: 12px !important;
      }

      .product-card button[onclick*="addToCart"] {
        background-color: #2563eb !important;
        font-weight: 600 !important;
        font-size: 12px !important;
      }

      .product-card button[onclick*="addToCart"]:hover {
        background-color: #1d4ed8 !important;
      }

      /* Rating clickable area */
      .product-card a[href*="product_detail"] {
        text-decoration: none !important;
      }

      .product-card a[href*="product_detail"]:hover {
        background-color: #f9fafb !important;
      }

      /* Ensure all text is visible */
      .product-card p,
      .product-card h3,
      .product-card div {
        color: inherit !important;
      }

      /* Force visibility of all elements */
      .product-card * {
        visibility: visible !important;
      }

      /* Supplier name specific styling */
      .product-card p.text-xs.font-semibold {
        color: #2563eb !important;
        font-weight: 600 !important;
        font-size: 12px !important;
      }

      /* Product name styling */
      .product-card h3 a {
        color: #1f2937 !important;
        font-size: 12px !important;
        font-weight: 500 !important;
      }

      /* Rating text styling */
      .product-card .text-xs.text-gray-700 {
        color: #374151 !important;
        font-size: 12px !important;
        font-weight: 600 !important;
      }

      .product-card .text-xs.text-gray-500 {
        color: #6b7280 !important;
        font-size: 12px !important;
      }

      /* Stock status styling - выделенный фон */
      .product-card span[style*="background: #dcfce7"] {
        color: #059669 !important;
        font-size: 12px !important;
        font-weight: 600 !important;
        background: #dcfce7 !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
      }

      .product-card span[style*="background: #fef2f2"] {
        color: #dc2626 !important;
        font-size: 12px !important;
        font-weight: 600 !important;
        background: #fef2f2 !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
      }

      /* Price styling - крупная и выделенная */
      .product-card div[style*="background: #f3f4f6"] {
        font-size: 16px !important;
        font-weight: 800 !important;
        background: #f3f4f6 !important;
        padding: 4px 8px !important;
        border-radius: 6px !important;
      }

      /* Red price text */
      .product-card div[style*="color: #dc2626"] {
        color: #dc2626 !important;
      }

      /* Green price text */
      .product-card div[style*="color: #059669"] {
        color: #059669 !important;
      }
      .price-current {
        color: #ff6b35;
        font-weight: 700;
      }
      .price-old {
        color: #9ca3af;
        text-decoration: line-through;
      }
      .rating-stars {
        color: #ffd700;
      }
      .category-item {
        transition: all 0.2s ease;
      }
      .category-item:hover {
        background: #f3f4f6;
        color: #005bff;
        transform: translateY(-2px);
      }

      /* External link styles - убрано для категорий */
      .search-input {
        border: 2px solid #005bff;
        border-radius: 8px 0 0 8px;
      }
      .search-btn {
        background: #005bff;
        border-radius: 0 8px 8px 0;
      }
      .cart-counter {
        background: #ff6b35;
        color: white;
        border-radius: 50%;
        min-width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }

      /* Enhanced Mega menu styles */
      .mega-menu {
        display: none;
        position: absolute;
        left: 0;
        top: 100%;
        width: 100vw;
        max-width: 1200px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 50;
        padding: 20px;
      }
      .mega-menu-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 20px;
      }
      .mega-menu-category {
        margin-bottom: 15px;
      }
      .mega-menu-category h3 {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #e5e7eb;
      }
      .mega-menu-subcategory {
        padding: 5px 0;
      }
      .mega-menu-subcategory a {
        color: #4b5563;
        transition: color 0.2s;
      }
      .mega-menu-subcategory a:hover {
        color: #005bff;
      }

      /* Enhanced mega menu animations */
      #catalogMegaMenu {
        transition: opacity 0.3s ease, transform 0.3s ease;
        transform-origin: top left;
      }

      #catalogMegaMenu.hidden {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
      }

      #catalogMegaMenu:not(.hidden) {
        display: block !important;
        z-index: 9999 !important;
        opacity: 1 !important;
        visibility: visible !important;
      }

      /* Force visibility when not hidden */
      #catalogMegaMenu {
        z-index: 9999 !important;
      }

      #catalogMegaMenu {
        z-index: 9999 !important;
      }

      /* Category link hover effects */
      .catalog-category-link {
        position: relative;
        overflow: hidden;
      }

      .catalog-category-link::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(59, 130, 246, 0.1),
          transparent
        );
        transition: left 0.5s;
      }

      .catalog-category-link:hover::before {
        left: 100%;
      }

      /* Loading indicators */
      .loading-shimmer {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      /* Search enhancements */
      #catalogSearch:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Category card hover effects */
      .category-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .category-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      /* Breadcrumb animations */
      #categoryBreadcrumbs {
        transition: all 0.3s ease;
      }

      #categoryBreadcrumbs.hidden {
        opacity: 0;
        transform: translateY(-10px);
      }

      /* Toast notifications */
      .toast {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Accessibility improvements */
      .catalog-category-link:focus {
        outline: 2px solid #2563eb;
        outline-offset: 2px;
      }

      /* Mobile responsiveness for mega menu */
      @media (max-width: 1024px) {
        #catalogMegaMenu {
          max-width: 100vw;
          left: -1rem;
          right: -1rem;
          width: calc(100vw + 2rem);
        }

        #catalogMegaMenu .flex {
          flex-direction: column;
          height: auto;
          max-height: 80vh;
        }

        #catalogMegaMenu .w-80 {
          width: 100%;
          max-height: 200px;
        }
      }

      @media (max-width: 768px) {
        #catalogMegaMenu .grid {
          grid-template-columns: 1fr;
        }

        #catalogMegaMenu .p-8 {
          padding: 1rem;
        }
      }

      /* Mobile menu button */
      .mobile-menu-btn {
        display: none;
      }

      @media (max-width: 768px) {
        .mobile-menu-btn {
          display: block;
        }
        .desktop-menu {
          display: none;
        }
      }

      /* RTL Support */
      [dir="rtl"] .flex-row-reverse {
        flex-direction: row-reverse;
      }

      [dir="rtl"] .text-left {
        text-align: right;
      }

      [dir="rtl"] .text-right {
        text-align: left;
      }

      [dir="rtl"] .ml-auto {
        margin-left: 0;
        margin-right: auto;
      }

      [dir="rtl"] .mr-auto {
        margin-right: 0;
        margin-left: auto;
      }

      [dir="rtl"] .pl-4 {
        padding-left: 0;
        padding-right: 1rem;
      }

      [dir="rtl"] .pr-4 {
        padding-right: 0;
        padding-left: 1rem;
      }

      [dir="rtl"] .ml-2 {
        margin-left: 0;
        margin-right: 0.5rem;
      }

      [dir="rtl"] .mr-2 {
        margin-right: 0;
        margin-left: 0.5rem;
      }

      [dir="rtl"] .space-x-4 > * + * {
        margin-left: 0;
        margin-right: 1rem;
      }

      [dir="rtl"] .space-x-6 > * + * {
        margin-left: 0;
        margin-right: 1.5rem;
      }

      [dir="rtl"] .space-x-8 > * + * {
        margin-left: 0;
        margin-right: 2rem;
      }

      /* Arabic font support */
      [dir="rtl"] body {
        font-family: "Cairo", "Tajawal", "Noto Sans Arabic", "Arial", sans-serif;
      }

      /* RTL specific adjustments */
      [dir="rtl"] .dropdown-menu {
        right: 0;
        left: auto;
      }

      [dir="rtl"] .search-icon {
        left: 0.75rem;
        right: auto;
      }

      [dir="rtl"] .search-input {
        padding-left: 2.5rem;
        padding-right: 1rem;
      }

      /* Product Slider Styles */
      :root {
        --tst: bottom 0.5s ease 0s;
        --dark: #e6e6e6ee;
      }

      .product-slider-container {
        background: #f8f9fa;
        font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
        font-size: 14px;
        color: #000;
        margin: 0;
        padding: 20px;
        overflow: hidden;
        border-radius: 10px;
      }

      .swiper {
        width: 100%;
        padding-top: 50px;
        padding-bottom: 50px;
      }

      .swiper-slide {
        background-position: center;
        background-size: cover;
        width: 400px;
        height: 500px;
        border-radius: 10px;
        overflow: hidden;
        border: 2px solid #ffffff;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .swiper-container-3d .swiper-slide-shadow-left {
        background-image: linear-gradient(to left, #000, #fff0);
        border-right: 1px solid #000;
        border-radius: 10px;
      }

      .swiper-container-3d .swiper-slide-shadow-right {
        background-image: linear-gradient(to right, #000, #fff0);
        box-shadow: 0 0 0 1px #000;
        border-radius: 10px;
      }

      .swiper-pagination-bullet {
        background: #696969;
        transition: all 0.5s ease 0s;
        border-radius: 8px;
      }

      .swiper-pagination-bullet-active {
        background: #ffc107;
        width: 30px;
      }

      .info {
        position: absolute;
        width: 100%;
        height: 40%;
        text-align: center;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.9) 100%
        );
        padding: 15px;
        left: 0;
        bottom: 0;
        box-sizing: border-box;
        transition: all 0.5s ease;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        z-index: 10;
      }

      .swiper-slide:not(.swiper-slide-active) .info {
        opacity: 0.3;
        visibility: visible;
        pointer-events: none;
      }

      .swiper-slide-active .info {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .info span {
        width: 100%;
        margin: 0.25em 0;
        display: block;
        padding: 0.3em;
        box-sizing: border-box;
        color: #ffffff;
        text-align: center;
        position: relative;
        text-transform: uppercase;
        font-size: 14px;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      }

      .info span:hover {
        background: rgba(255, 255, 255, 0.1);
        transition: background 0.3s ease;
      }

      .swiper-slide-active .info span {
        font-size: 14px;
        font-weight: 700;
      }

      .info span:first-child {
        font-size: 18px;
        margin-bottom: 5px;
        font-weight: 900;
        color: #ffffff;
      }

      .swiper-slide-active .info span:first-child {
        font-size: 20px;
        margin-bottom: 8px;
      }

      /* Анимация бесконечного ползунка */
      @keyframes marquee {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(-50%);
        }
      }

      .animate-marquee {
        animation: marquee 30s linear infinite;
      }

      .animate-marquee:hover {
        animation-play-state: paused;
      }

      .info span:nth-child(2):before {
        background: #ff6b35;
      }

      .info span:nth-child(3):before {
        background: #005bff;
      }

      .info span:nth-child(4):before {
        background: #ffc107;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Header -->
    <header class="header-gradient shadow-sm sticky top-0 z-50">
      <!-- Top Bar -->
      <!-- Topbar -->
      {% include 'components/topbar.html' %}

      <!-- Header -->
      {% include 'components/header.html' %}
    </header>

    <!-- Категории под поисковой строкой -->
    <div class="bg-white py-4">
      <div class="max-w-8xl mx-auto px-6 sm:px-8 lg:px-12">
        <div class="relative overflow-hidden">
          <!-- Бесконечная карусель категорий -->
          <div
            class="flex items-center space-x-6 animate-marquee"
            id="categoriesCarousel"
          >
            <!-- Первый набор категорий -->
            {% for category in categories %}
            <a
              href="{% url 'category' category.slug %}"
              class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 whitespace-nowrap flex-shrink-0"
            >
              {% if category.icon %}
              <i class="{{ category.icon }} text-blue-600"></i>
              {% endif %}
              <span class="text-sm font-medium">{{ category.name }}</span>
            </a>
            {% endfor %}
            <!-- Дублируем категории для бесконечного эффекта -->
            {% for category in categories %}
            <a
              href="{% url 'category' category.slug %}"
              class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 whitespace-nowrap flex-shrink-0"
            >
              {% if category.icon %}
              <i class="{{ category.icon }} text-blue-600"></i>
              {% endif %}
              <span class="text-sm font-medium">{{ category.name }}</span>
            </a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="min-h-screen">{% block content %}{% endblock %}</main>

    <!-- Footer -->
    {% include 'components/footer.html' %}

    <!-- Notifications -->
    <div id="notifications" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <!-- Scripts -->
    <script src="{% static 'js/catalog.js' %}"></script>
    <script>
      // Get CSRF token from meta tag
      function getCSRFToken() {
        // Try to get from meta tag first
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken) {
          const token = metaToken.getAttribute("content");
          if (token) {
            return token;
          }
        }

        // Fallback to hidden input field
        const inputToken = document.querySelector("[name=csrfmiddlewaretoken]");
        if (inputToken) {
          return inputToken.value;
        }

        // Final fallback to cookie
        return getCookie("csrftoken");
      }

      // Get CSRF token from cookie
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Load cart count
      function loadCartCount() {
        fetch('{% url "cart_count" %}', {
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            const cartCounter = document.getElementById("cart-counter");
            if (cartCounter) {
              cartCounter.textContent = data.count || 0;
            }
          })
          .catch((error) => {
            console.error("Error loading cart count:", error);
            const cartCounter = document.getElementById("cart-counter");
            if (cartCounter) {
              cartCounter.textContent = "0";
            }
          });
      }

      // Add to cart
      function addToCart(productId, quantity = 1) {
        fetch(`/cart/add/${productId}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify({ quantity: quantity }),
        })
          .then((response) => {
            // Проверяем Content-Type ответа
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              // Если ответ не JSON, возможно пользователь не авторизован
              // Но система корзины работает и для неавторизованных пользователей через сессии
              showNotification("Товар добавлен в корзину", "success");
              loadCartCount();
              animateCartCounter();
              return null;
            }

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            if (data !== null) {
              if (data && data.success) {
                showNotification(data.message, "success");
                loadCartCount();
                animateCartCounter();
              } else if (data && data.redirect) {
                // Redirect to login page
                window.location.href = data.redirect;
              } else if (data) {
                showNotification(
                  data.message || "Ошибка при добавлении в корзину",
                  "error"
                );
              }
            }
          })
          .catch((error) => {
            console.error("Error adding to cart:", error);
            showNotification("Ошибка при добавлении в корзину", "error");
          });
      }

      // Show notification
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `p-4 rounded-lg shadow-lg max-w-sm ${
          type === "success"
            ? "bg-green-500"
            : type === "error"
            ? "bg-red-500"
            : "bg-blue-500"
        } text-white`;
        notification.textContent = message;

        const notificationsContainer = document.getElementById("notifications");
        if (notificationsContainer) {
          notificationsContainer.appendChild(notification);
        } else {
          // Fallback: append to body
          document.body.appendChild(notification);
        }

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // Animate cart counter
      function animateCartCounter() {
        const counter = document.getElementById("cart-counter");
        if (counter) {
          counter.style.transform = "scale(1.2)";
          setTimeout(() => {
            counter.style.transform = "scale(1)";
          }, 200);
        }
      }

      // Load cart count on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadCartCount();
      });

      // Location dropdown functions
      function toggleLocationDropdown() {
        const dropdown = document.getElementById("locationDropdown");
        if (dropdown) {
          dropdown.classList.toggle("hidden");
        }
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (event) {
        const dropdown = document.getElementById("locationDropdown");
        const locationTrigger = event.target.closest(".relative.group");

        if (
          dropdown &&
          !locationTrigger &&
          !dropdown.classList.contains("hidden")
        ) {
          dropdown.classList.add("hidden");
        }
      });
    </script>

    <!-- Location management script -->
    <script src="{% static 'js/location.js' %}"></script>

    <!-- Catalog data -->
    <script>
      console.log('Catalog categories count:', {{ catalog_categories|length }});
      window.catalogData = {
          {% for category in catalog_categories %}
          {{ category.id }}: {
              name: "{{ category.name|escapejs }}",
              icon: "{{ category.icon|escapejs }}",
              slug: "{{ category.slug|escapejs }}",
              subcategories: []
          }{% if not forloop.last %},{% endif %}
          {% endfor %}
      };
      console.log('Catalog data loaded:', window.catalogData);
    </script>

    <!-- Favorites JavaScript -->
    <script>
      // Функция для переключения избранного
      function toggleFavorite(productId) {
        const button = document.querySelector(
          `[data-product-id="${productId}"]`
        );
        if (!button) return;

        const heartIcon = button.querySelector("i");

        // Проверяем текущий статус
        fetch(`/favorites/check/${productId}/`)
          .then((response) => {
            // Проверяем Content-Type ответа
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              // Если ответ не JSON, возможно пользователь не авторизован
              return { is_favorite: false };
            }
            return response.json();
          })
          .then((data) => {
            if (data.is_favorite) {
              // Удаляем из избранного
              removeFromFavorites(productId, button, heartIcon);
            } else {
              // Добавляем в избранное
              addToFavorites(productId, button, heartIcon);
            }
          })
          .catch((error) => {
            console.error("Ошибка проверки статуса избранного:", error);
            showNotification("Ошибка проверки статуса избранного", "error");
          });
      }

      // Функция для добавления в избранное
      function addToFavorites(productId, button, heartIcon) {
        fetch(`/favorites/add/${productId}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then((response) => {
            // Проверяем Content-Type ответа
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              // Если ответ не JSON, возможно пользователь не авторизован
              // Но система избранного работает и для неавторизованных пользователей через сессии
              return { success: true, message: "Товар добавлен в избранное" };
            }
            return response.json();
          })
          .then((data) => {
            if (data && data.success) {
              // Обновляем кнопку
              if (heartIcon) {
                heartIcon.classList.remove("text-gray-400");
                heartIcon.classList.add("text-red-500");
                heartIcon.classList.remove("far");
                heartIcon.classList.add("fas");
              }
              showNotification(data.message, "success");
            } else if (data) {
              showNotification(
                data.message || "Ошибка при добавлении в избранное",
                "info"
              );
            }
          })
          .catch((error) => {
            console.error("Ошибка добавления в избранное:", error);
            showNotification("Ошибка добавления в избранное", "error");
          });
      }

      // Функция для удаления из избранного
      function removeFromFavorites(productId, button, heartIcon) {
        fetch(`/favorites/remove/${productId}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then((response) => {
            // Проверяем Content-Type ответа
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              // Если ответ не JSON, возможно пользователь не авторизован
              // Но система избранного работает и для неавторизованных пользователей через сессии
              return { success: true, message: "Товар удален из избранного" };
            }
            return response.json();
          })
          .then((data) => {
            if (data && data.success) {
              // Обновляем кнопку
              if (heartIcon) {
                heartIcon.classList.remove("text-red-500");
                heartIcon.classList.add("text-gray-400");
                heartIcon.classList.remove("fas");
                heartIcon.classList.add("far");
              }
              showNotification(data.message, "success");
            } else if (data) {
              showNotification(
                data.message || "Ошибка при удалении из избранного",
                "info"
              );
            }
          })
          .catch((error) => {
            console.error("Ошибка удаления из избранного:", error);
            showNotification("Ошибка удаления из избранного", "error");
          });
      }

      // Функция для обновления кнопки избранного
      function updateFavoriteButton(productId, isFavorite) {
        const buttons = document.querySelectorAll(
          `[data-product-id="${productId}"]`
        );
        buttons.forEach((button) => {
          const heartIcon = button.querySelector("i");
          if (heartIcon) {
            if (isFavorite) {
              heartIcon.classList.remove("text-gray-400");
              heartIcon.classList.add("text-red-500");
              heartIcon.classList.remove("far");
              heartIcon.classList.add("fas");
            } else {
              heartIcon.classList.remove("text-red-500");
              heartIcon.classList.add("text-gray-400");
              heartIcon.classList.remove("fas");
              heartIcon.classList.add("far");
            }
          }
        });
      }

      // Инициализация статуса избранного для всех товаров при загрузке страницы
      document.addEventListener("DOMContentLoaded", function () {
        const favoriteButtons = document.querySelectorAll(".favorite-btn");
        favoriteButtons.forEach((button) => {
          const productId = button.getAttribute("data-product-id");
          if (productId) {
            // Проверяем статус избранного для каждого товара
            fetch(`/favorites/check/${productId}/`)
              .then((response) => response.json())
              .then((data) => {
                updateFavoriteButton(productId, data.is_favorite);
              })
              .catch((error) => {
                console.error("Ошибка проверки статуса избранного:", error);
              });
          }
        });

        // MegaMenuManager инициализируется в catalog.js
        console.log("🚀 MegaMenuManager will be initialized by catalog.js");

        // Дополнительные функции будут инициализированы автоматически
        if (false) {
          console.error("❌ MegaMenuManager not found!");
        }
      });
    </script>
  </body>
</html>
