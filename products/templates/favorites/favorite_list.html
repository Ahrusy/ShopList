{% extends 'base_ozon.html' %}
{% load static %}
{% load i18n %}

{% block title %}Избранное - ShopList{% endblock %}

{% block content %}
{% csrf_token %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Заголовок страницы в стиле Ozon -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            Избранное • Подборки • Вишлисты • Магазины и Бренды
        </h1>
    </div>

    {% if favorites %}
        <!-- Действия с избранным -->
        <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Выбрать все</span>
                    </label>
                    <span class="text-sm text-gray-500" id="selectedCount">0 товаров выбрано</span>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button id="addSelectedToCart" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm" disabled>
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Добавить в корзину
                    </button>
                    <button id="removeSelected" class="px-4 py-2 bg-red-50 text-red-700 rounded-md hover:bg-red-100 transition-colors text-sm" disabled>
                        <i class="fas fa-trash mr-2"></i>
                        Удалить
                    </button>
                </div>
            </div>
        </div>

        <!-- Сетка товаров -->
        <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for product in favorites %}
                {% include 'components/product_card.html' %}
            {% endfor %}
        </div>

    {% else %}
        <!-- Пустое состояние в стиле Ozon -->
        <div class="text-center py-16">
            <div class="mx-auto w-32 h-32 mb-6 flex items-center justify-center">
                <!-- SVG иконка коробки с сердцем -->
                <svg width="128" height="128" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Коробка -->
                    <rect x="20" y="40" width="88" height="60" rx="4" fill="#F3F4F6" stroke="#E5E7EB" stroke-width="2"/>
                    <rect x="20" y="40" width="88" height="20" rx="4" fill="#F9FAFB" stroke="#E5E7EB" stroke-width="2"/>
                    <path d="M20 60 L108 60 L108 100 L20 100 Z" fill="#F3F4F6" stroke="#E5E7EB" stroke-width="2"/>
                    
                    <!-- Сердце -->
                    <g transform="translate(64, 30)">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" 
                              fill="#EC4899" stroke="#EC4899" stroke-width="1"/>
                    </g>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">В избранном пока пусто</h3>
            <p class="text-gray-600 mb-8 max-w-md mx-auto">
                Добавляйте товары с помощью ❤️, чтобы не потерять их и купить позже
            </p>
            <a href="/" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                <i class="fas fa-shopping-cart mr-2"></i>
                Начать покупки
            </a>
        </div>

        <!-- Рекомендуемые товары -->
        <div class="mt-16">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Подобрано для вас</h2>
            <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {% for product in recommended_products|slice:":4" %}
                    {% include 'components/product_card.html' %}
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

<!-- JavaScript для интерактивности -->
<script>
let selectedItems = new Set();

// Выбор всех товаров
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
        if (this.checked) {
            selectedItems.add(checkbox.dataset.itemId);
        } else {
            selectedItems.delete(checkbox.dataset.itemId);
        }
    });
    updateSelectedCount();
});

// Выбор отдельных товаров
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('item-checkbox')) {
        const itemId = e.target.dataset.itemId;
        if (e.target.checked) {
            selectedItems.add(itemId);
        } else {
            selectedItems.delete(itemId);
        }
        updateSelectedCount();
    }
});

function updateSelectedCount() {
    const count = selectedItems.size;
    document.getElementById('selectedCount').textContent = `${count} товар${count === 1 ? '' : count < 5 ? 'а' : 'ов'} выбрано`;
    
    const addToCartBtn = document.getElementById('addSelectedToCart');
    const removeBtn = document.getElementById('removeSelected');
    
    if (count > 0) {
        addToCartBtn.disabled = false;
        removeBtn.disabled = false;
    } else {
        addToCartBtn.disabled = true;
        removeBtn.disabled = true;
    }
}

// Добавление выбранных товаров в корзину
document.getElementById('addSelectedToCart').addEventListener('click', function() {
    if (selectedItems.size === 0) return;
    
    const productIds = Array.from(selectedItems);
    
    fetch('/api/cart/add-multiple/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_ids: productIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Товары добавлены в корзину', 'success');
            // Убираем выбранные товары из избранного
            selectedItems.forEach(itemId => {
                removeFromFavorites(itemId);
            });
            selectedItems.clear();
            updateSelectedCount();
        } else {
            showNotification('Ошибка при добавлении в корзину', 'error');
        }
    });
});

// Удаление выбранных товаров
document.getElementById('removeSelected').addEventListener('click', function() {
    if (selectedItems.size === 0) return;
    
    if (confirm(`Удалить ${selectedItems.size} товар${selectedItems.size === 1 ? '' : 'ов'} из избранного?`)) {
        selectedItems.forEach(itemId => {
            removeFromFavorites(itemId);
        });
        selectedItems.clear();
        updateSelectedCount();
    }
});

function removeFromFavorites(itemId) {
    fetch(`/api/favorites/${itemId}/remove/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Удаляем элемент из DOM
            const itemElement = document.querySelector(`[data-item-id="${itemId}"]`).closest('.border');
            if (itemElement) {
                itemElement.remove();
            }
            showNotification('Товар удален из избранного', 'success');
        } else {
            showNotification('Ошибка при удалении товара', 'error');
        }
    });
}

function addToCart(productId) {
    fetch('/api/cart/add/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Товар добавлен в корзину', 'success');
            loadCartCount();
        } else {
            showNotification('Ошибка при добавлении в корзину', 'error');
        }
    });
}

function showNotification(message, type = 'info') {
    // Создаем уведомление
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Удаляем через 3 секунды
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Функции для работы с избранным
function removeFromFavorites(productId) {
    fetch(`{% url 'favorites:remove_from_favorites' 0 %}`.replace('0', productId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка при удалении из избранного');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при удалении из избранного');
    });
}

function addToCart(productId) {
    fetch(`{% url 'add_to_cart' 0 %}`.replace('0', productId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ quantity: 1 })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const cartCounter = document.getElementById('cart-counter');
            if (cartCounter) {
                cartCounter.textContent = data.cart_count || 0;
            }
            alert('Товар добавлен в корзину!');
        } else {
            alert('Ошибка при добавлении в корзину');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при добавлении в корзину');
    });
}

function toggleFavorite(productId) {
    // This function is defined in base_ozon.html
    if (typeof window.toggleFavorite === 'function') {
        window.toggleFavorite(productId);
    }
}
</script>
{% endblock %}
