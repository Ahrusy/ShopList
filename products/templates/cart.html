{% extends 'base_ozon.html' %}

{% block title %}Корзина{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-2xl font-bold text-gray-900 mb-6">Корзина</h1>
    
    {% if cart_items %}
    <div class="lg:grid lg:grid-cols-12 lg:gap-x-12 xl:gap-x-16">
        <div class="lg:col-span-7">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <ul class="divide-y divide-gray-200">
                    {% for item in cart_items %}
                    <li class="p-6 cart-item" data-product-id="{{ item.product.id }}">
                        <div class="flex">
                            <!-- Product Image -->
                            <div class="flex-shrink-0 w-24 h-24 border border-gray-200 rounded-md overflow-hidden">
                                {% if item.product.images.first %}
                                    <img src="{{ item.product.images.first.image.url }}" 
                                         alt="{{ item.product.name }}" 
                                         class="w-full h-full object-contain">
                                {% else %}
                                    <div class="w-full h-full bg-gray-100 flex items-center justify-center">
                                        <i class="fas fa-image text-gray-400"></i>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Product Details -->
                            <div class="ml-4 flex-1 flex flex-col">
                                <div>
                                    <div class="flex justify-between text-base font-medium text-gray-900">
                                        <h3>
                                            <a href="{% url 'product_detail' item.product.pk %}" class="hover:text-blue-600">
                                                {{ item.product.name }}
                                            </a>
                                        </h3>
                                        <p class="ml-4">
                                            {% if item.product.discount_price %}
                                                {{ item.product.discount_price|floatformat:2 }} ₽
                                            {% else %}
                                                {{ item.product.price|floatformat:2 }} ₽
                                            {% endif %}
                                        </p>
                                    </div>
                                    <p class="mt-1 text-sm text-gray-500">Артикул: {{ item.product.sku }}</p>
                                </div>
                                
                                <div class="flex-1 flex items-end justify-between text-sm">
                                    <!-- Quantity Controls -->
                                    <div class="flex items-center border border-gray-300 rounded">
                                        <button class="quantity-btn w-8 h-8 flex items-center justify-center hover:bg-gray-50" 
                                                data-action="decrease" data-product-id="{{ item.product.id }}">
                                            <i class="fas fa-minus text-gray-600"></i>
                                        </button>
                                        <span class="quantity-display w-12 text-center font-medium" data-product-id="{{ item.product.id }}">
                                            {% if item.quantity %}{{ item.quantity }}{% else %}1{% endif %}
                                        </span>
                                        <button class="quantity-btn w-8 h-8 flex items-center justify-center hover:bg-gray-50" 
                                                data-action="increase" data-product-id="{{ item.product.id }}">
                                            <i class="fas fa-plus text-gray-600"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="flex items-center space-x-4">
                                        <button class="favorite-btn text-gray-400 hover:text-red-500 transition-colors" 
                                                data-product-id="{{ item.product.id }}"
                                                onclick="toggleFavorite({{ item.product.id }})"
                                                title="Добавить в избранное">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                        <button class="remove-item font-medium text-red-600 hover:text-red-500" 
                                                data-product-id="{{ item.product.id }}">
                                            Удалить
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="mt-10 lg:mt-0 lg:col-span-5">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Итого</h2>
                
                <div class="space-y-4">
                    <div class="flex justify-between text-base font-medium text-gray-900">
                        <p>Подытог</p>
                        <p>{{ cart_total_price|default:0|floatformat:2 }} ₽</p>
                    </div>
                    
                    <div class="flex justify-between">
                        <p class="text-sm text-gray-600">Доставка</p>
                        <p class="text-sm text-gray-600">Бесплатно</p>
                    </div>
                    
                    <div class="flex justify-between">
                        <p class="text-sm text-gray-600">Налоги</p>
                        <p class="text-sm text-gray-600">0 ₽</p>
                    </div>
                    
                    <div class="flex justify-between border-t border-gray-200 pt-4">
                        <p class="text-base font-medium text-gray-900">Общая сумма</p>
                        <p class="text-base font-medium text-gray-900">{{ cart_total_price|default:0|floatformat:2 }} ₽</p>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button onclick="window.location.href='/ru/checkout/'"
                            class="w-full bg-blue-600 border border-transparent rounded-md shadow-sm py-3 px-4 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Оформить заказ
                    </button>
                </div>
                
                <div class="mt-4 text-sm text-center">
                    <p class="text-gray-500">
                        или
                        <a href="/ru/" class="text-blue-600 font-medium hover:text-blue-500">
                            Продолжить покупки
                            <span aria-hidden="true"> &rarr;</span>
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Empty Cart -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
        <i class="fas fa-shopping-cart text-gray-400 text-6xl mb-4"></i>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Ваша корзина пуста</h2>
        <p class="text-gray-500 mb-8">Добавьте товары в корзину, чтобы оформить заказ</p>
        <a href="/ru/" 
           class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
            Продолжить покупки
        </a>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Quantity controls
    document.querySelectorAll('.quantity-btn').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const productId = this.dataset.productId;
            const quantityDisplay = document.querySelector(`.quantity-display[data-product-id="${productId}"]`);
            let currentQuantity = parseInt(quantityDisplay.textContent);
            
            if (action === 'increase') {
                currentQuantity += 1;
            } else if (action === 'decrease' && currentQuantity > 1) {
                currentQuantity -= 1;
            }
            
            quantityDisplay.textContent = currentQuantity;
            
            // Update cart via AJAX
            fetch(`/ru/cart/update/${productId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    quantity: currentQuantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update cart counter if it exists
                    const cartCounter = document.getElementById('cart-counter');
                    if (cartCounter) {
                        cartCounter.textContent = data.cart_count;
                    }
                    // Reload the page to update totals
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error updating cart:', error);
            });
        });
    });
    
    // Remove item functionality
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const cartItem = this.closest('.cart-item');
            
            fetch(`/ru/cart/remove/${productId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cartItem.remove();
                    
                    // Update cart counter if it exists
                    const cartCounter = document.getElementById('cart-counter');
                    if (cartCounter) {
                        cartCounter.textContent = data.cart_count;
                    }
                    
                    // Check if cart is empty
                    const remainingItems = document.querySelectorAll('.cart-item');
                    if (remainingItems.length === 0) {
                        location.reload();
                    } else {
                        // Reload to update totals
                        location.reload();
                    }
                }
            })
            .catch(error => {
                console.error('Error removing item:', error);
            });
        });
    });
});
</script>
{% endblock %}