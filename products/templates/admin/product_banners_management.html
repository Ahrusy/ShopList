{% extends 'base_ozon.html' %}
{% load static %}

{% block title %}Управление товарными баннерами{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Управление товарными баннерами</h1>
            <p class="mt-2 text-gray-600">Создавайте и управляйте баннерами для слайдера на главной странице</p>
        </div>

        <!-- Controls -->
        <div class="mb-6 flex flex-col sm:flex-row gap-4">
            <button id="addBannerBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>Добавить баннер
            </button>
            <button id="reorderBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-sort mr-2"></i>Изменить порядок
            </button>
            <div class="flex-1"></div>
            <div class="flex gap-2">
                <select id="styleFilter" class="border border-gray-300 rounded-lg px-3 py-2">
                    <option value="">Все стили</option>
                    <option value="new">Новинка</option>
                    <option value="discount">Скидка</option>
                    <option value="premium">Премиум</option>
                    <option value="delivery">Доставка</option>
                    <option value="popular">Популярное</option>
                    <option value="sale">Распродажа</option>
                </select>
                <button id="refreshBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loadingIndicator" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">Загрузка...</p>
        </div>

        <!-- Banners Grid -->
        <div id="bannersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Banners will be loaded here -->
        </div>

        <!-- Pagination -->
        <div id="pagination" class="mt-8 flex justify-center">
            <!-- Pagination will be loaded here -->
        </div>
    </div>
</div>

<!-- Add/Edit Banner Modal -->
<div id="bannerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-xl font-semibold">Добавить баннер</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="bannerForm" enctype="multipart/form-data">
                    <input type="hidden" id="bannerId" name="id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Заголовок *</label>
                            <input type="text" id="title" name="title" required
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="md:col-span-2">
                            <label for="subtitle" class="block text-sm font-medium text-gray-700 mb-1">Подзаголовок</label>
                            <input type="text" id="subtitle" name="subtitle"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                            <textarea id="description" name="description" rows="3"
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>

                        <div>
                            <label for="style" class="block text-sm font-medium text-gray-700 mb-1">Стиль *</label>
                            <select id="style" name="style" required
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="new">Новинка</option>
                                <option value="discount">Скидка</option>
                                <option value="premium">Премиум</option>
                                <option value="delivery">Доставка</option>
                                <option value="popular">Популярное</option>
                                <option value="sale">Распродажа</option>
                            </select>
                        </div>

                        <div>
                            <label for="sort_order" class="block text-sm font-medium text-gray-700 mb-1">Порядок</label>
                            <input type="number" id="sort_order" name="sort_order" min="0"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label for="button_text" class="block text-sm font-medium text-gray-700 mb-1">Текст кнопки</label>
                            <input type="text" id="button_text" name="button_text" value="Подробнее"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label for="link" class="block text-sm font-medium text-gray-700 mb-1">Ссылка</label>
                            <input type="url" id="link" name="link"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label for="background_color" class="block text-sm font-medium text-gray-700 mb-1">Цвет фона</label>
                            <input type="color" id="background_color" name="background_color" value="#000000"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label for="text_color" class="block text-sm font-medium text-gray-700 mb-1">Цвет текста</label>
                            <input type="color" id="text_color" name="text_color" value="#FFFFFF"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="md:col-span-2">
                            <label for="image" class="block text-sm font-medium text-gray-700 mb-1">Изображение</label>
                            <input type="file" id="image" name="image" accept="image/*"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div id="currentImage" class="mt-2 hidden">
                                <p class="text-sm text-gray-600">Текущее изображение:</p>
                                <img id="currentImagePreview" src="" alt="Current image" class="mt-1 w-32 h-20 object-cover rounded">
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="is_active" name="is_active" checked
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Активен</span>
                            </label>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" id="cancelBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Отмена
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                </div>
                <div class="text-center">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Удалить баннер</h3>
                    <p class="text-sm text-gray-500 mb-4">Вы уверены, что хотите удалить этот баннер? Это действие нельзя отменить.</p>
                    <div class="flex justify-center gap-3">
                        <button id="cancelDelete" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Отмена
                        </button>
                        <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentBanners = [];
let currentPage = 1;
let totalPages = 1;
let isReorderMode = false;
let bannerToDelete = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadBanners();
    setupEventListeners();
});

// Event listeners
function setupEventListeners() {
    // Add banner button
    document.getElementById('addBannerBtn').addEventListener('click', () => {
        openModal();
    });

    // Close modal buttons
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);

    // Form submission
    document.getElementById('bannerForm').addEventListener('submit', handleFormSubmit);

    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', loadBanners);

    // Style filter
    document.getElementById('styleFilter').addEventListener('change', (e) => {
        loadBanners(1, e.target.value);
    });

    // Reorder button
    document.getElementById('reorderBtn').addEventListener('click', toggleReorderMode);

    // Delete modal
    document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
    document.getElementById('confirmDelete').addEventListener('click', confirmDelete);
}

// Load banners
async function loadBanners(page = 1, styleFilter = '') {
    showLoading(true);
    
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 12
        });
        
        if (styleFilter) {
            params.append('style', styleFilter);
        }
        
        const response = await fetch(`/api/product-banners/?${params}`);
        const data = await response.json();
        
        if (data.success) {
            currentBanners = data.data;
            currentPage = data.pagination.current_page;
            totalPages = data.pagination.total_pages;
            
            renderBanners();
            renderPagination(data.pagination);
        } else {
            showError('Ошибка загрузки баннеров: ' + data.error);
        }
    } catch (error) {
        showError('Ошибка загрузки баннеров: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Render banners
function renderBanners() {
    const grid = document.getElementById('bannersGrid');
    
    if (currentBanners.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <i class="fas fa-image text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Баннеры не найдены</h3>
                <p class="text-gray-500">Создайте первый баннер для слайдера</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = currentBanners.map(banner => `
        <div class="bg-white rounded-lg shadow-md overflow-hidden ${isReorderMode ? 'cursor-move' : ''}" 
             data-banner-id="${banner.id}" ${isReorderMode ? 'draggable="true"' : ''}>
            <div class="relative">
                ${banner.image_url ? 
                    `<img src="${banner.image_url}" alt="${banner.title}" class="w-full h-48 object-cover">` :
                    `<div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-image text-4xl text-gray-400"></i>
                    </div>`
                }
                <div class="absolute top-2 right-2">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getStyleColor(banner.style)}">
                        ${banner.style_display}
                    </span>
                </div>
                <div class="absolute top-2 left-2">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${banner.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${banner.is_active ? 'Активен' : 'Неактивен'}
                    </span>
                </div>
            </div>
            
            <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-1">${banner.title}</h3>
                <p class="text-sm text-gray-600 mb-2">${banner.subtitle || ''}</p>
                <p class="text-xs text-gray-500 mb-3">Порядок: ${banner.sort_order}</p>
                
                ${!isReorderMode ? `
                    <div class="flex gap-2">
                        <button onclick="editBanner(${banner.id})" class="flex-1 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                            <i class="fas fa-edit mr-1"></i>Изменить
                        </button>
                        <button onclick="toggleBanner(${banner.id})" class="px-3 py-1 rounded text-sm ${banner.is_active ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700'} text-white">
                            <i class="fas fa-${banner.is_active ? 'pause' : 'play'}"></i>
                        </button>
                        <button onclick="deleteBanner(${banner.id})" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : ''}
            </div>
        </div>
    `).join('');
    
    if (isReorderMode) {
        setupDragAndDrop();
    }
}

// Get style color
function getStyleColor(style) {
    const colors = {
        'new': 'bg-blue-100 text-blue-800',
        'discount': 'bg-red-100 text-red-800',
        'premium': 'bg-purple-100 text-purple-800',
        'delivery': 'bg-green-100 text-green-800',
        'popular': 'bg-yellow-100 text-yellow-800',
        'sale': 'bg-orange-100 text-orange-800'
    };
    return colors[style] || 'bg-gray-100 text-gray-800';
}

// Render pagination
function renderPagination(pagination) {
    const container = document.getElementById('pagination');
    
    if (pagination.total_pages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '<nav class="flex items-center justify-center space-x-2">';
    
    // Previous button
    if (pagination.has_previous) {
        html += `<button onclick="loadBanners(${pagination.current_page - 1})" class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
            <i class="fas fa-chevron-left"></i>
        </button>`;
    }
    
    // Page numbers
    for (let i = 1; i <= pagination.total_pages; i++) {
        if (i === pagination.current_page) {
            html += `<button class="px-3 py-2 bg-blue-600 text-white rounded-lg">${i}</button>`;
        } else {
            html += `<button onclick="loadBanners(${i})" class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">${i}</button>`;
        }
    }
    
    // Next button
    if (pagination.has_next) {
        html += `<button onclick="loadBanners(${pagination.current_page + 1})" class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
            <i class="fas fa-chevron-right"></i>
        </button>`;
    }
    
    html += '</nav>';
    container.innerHTML = html;
}

// Modal functions
function openModal(banner = null) {
    const modal = document.getElementById('bannerModal');
    const form = document.getElementById('bannerForm');
    const title = document.getElementById('modalTitle');
    
    if (banner) {
        title.textContent = 'Изменить баннер';
        fillForm(banner);
    } else {
        title.textContent = 'Добавить баннер';
        form.reset();
        document.getElementById('currentImage').classList.add('hidden');
    }
    
    modal.classList.remove('hidden');
}

function closeModal() {
    document.getElementById('bannerModal').classList.add('hidden');
}

function fillForm(banner) {
    document.getElementById('bannerId').value = banner.id;
    document.getElementById('title').value = banner.title;
    document.getElementById('subtitle').value = banner.subtitle || '';
    document.getElementById('description').value = banner.description || '';
    document.getElementById('style').value = banner.style;
    document.getElementById('sort_order').value = banner.sort_order;
    document.getElementById('button_text').value = banner.button_text;
    document.getElementById('link').value = banner.link || '';
    document.getElementById('background_color').value = banner.background_color;
    document.getElementById('text_color').value = banner.text_color;
    document.getElementById('is_active').checked = banner.is_active;
    
    if (banner.image_url) {
        document.getElementById('currentImagePreview').src = banner.image_url;
        document.getElementById('currentImage').classList.remove('hidden');
    } else {
        document.getElementById('currentImage').classList.add('hidden');
    }
}

// Form submission
async function handleFormSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const bannerId = formData.get('id');
    
    try {
        const url = bannerId ? 
            `/api/product-banners/${bannerId}/update/` : 
            '/api/product-banners/create/';
        
        const method = bannerId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.data.message || 'Баннер успешно сохранен');
            closeModal();
            loadBanners();
        } else {
            showError('Ошибка сохранения: ' + data.error);
        }
    } catch (error) {
        showError('Ошибка сохранения: ' + error.message);
    }
}

// Edit banner
async function editBanner(bannerId) {
    try {
        const response = await fetch(`/api/product-banners/${bannerId}/`);
        const data = await response.json();
        
        if (data.success) {
            openModal(data.data);
        } else {
            showError('Ошибка загрузки баннера: ' + data.error);
        }
    } catch (error) {
        showError('Ошибка загрузки баннера: ' + error.message);
    }
}

// Toggle banner status
async function toggleBanner(bannerId) {
    try {
        const response = await fetch(`/api/product-banners/${bannerId}/toggle/`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.data.message);
            loadBanners();
        } else {
            showError('Ошибка изменения статуса: ' + data.error);
        }
    } catch (error) {
        showError('Ошибка изменения статуса: ' + error.message);
    }
}

// Delete banner
function deleteBanner(bannerId) {
    bannerToDelete = bannerId;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    bannerToDelete = null;
}

async function confirmDelete() {
    if (!bannerToDelete) return;
    
    try {
        const response = await fetch(`/api/product-banners/${bannerToDelete}/delete/`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(data.message);
            closeDeleteModal();
            loadBanners();
        } else {
            showError('Ошибка удаления: ' + data.error);
        }
    } catch (error) {
        showError('Ошибка удаления: ' + error.message);
    }
}

// Reorder mode
function toggleReorderMode() {
    isReorderMode = !isReorderMode;
    const btn = document.getElementById('reorderBtn');
    
    if (isReorderMode) {
        btn.textContent = 'Завершить сортировку';
        btn.className = 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors';
    } else {
        btn.textContent = 'Изменить порядок';
        btn.className = 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors';
    }
    
    renderBanners();
}

// Drag and drop
function setupDragAndDrop() {
    const grid = document.getElementById('bannersGrid');
    let draggedElement = null;
    
    grid.addEventListener('dragstart', (e) => {
        draggedElement = e.target;
        e.target.style.opacity = '0.5';
    });
    
    grid.addEventListener('dragend', (e) => {
        e.target.style.opacity = '1';
        draggedElement = null;
    });
    
    grid.addEventListener('dragover', (e) => {
        e.preventDefault();
    });
    
    grid.addEventListener('drop', (e) => {
        e.preventDefault();
        
        if (draggedElement && e.target !== draggedElement) {
            const targetBanner = e.target.closest('[data-banner-id]');
            if (targetBanner) {
                const draggedId = draggedElement.dataset.bannerId;
                const targetId = targetBanner.dataset.bannerId;
                
                // Swap sort orders
                const draggedBanner = currentBanners.find(b => b.id == draggedId);
                const targetBanner = currentBanners.find(b => b.id == targetId);
                
                if (draggedBanner && targetBanner) {
                    const tempOrder = draggedBanner.sort_order;
                    draggedBanner.sort_order = targetBanner.sort_order;
                    targetBanner.sort_order = tempOrder;
                    
                    // Update in database
                    updateBannerOrder();
                }
            }
        }
    });
}

// Update banner order
async function updateBannerOrder() {
    const bannerOrders = currentBanners.map(banner => ({
        id: banner.id,
        sort_order: banner.sort_order
    }));
    
    try {
        const response = await fetch('/api/product-banners/reorder/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ banner_orders: bannerOrders })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('Порядок баннеров обновлен');
            loadBanners();
        } else {
            showError('Ошибка обновления порядка: ' + data.error);
        }
    } catch (error) {
        showError('Ошибка обновления порядка: ' + error.message);
    }
}

// Utility functions
function showLoading(show) {
    document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
}

function showSuccess(message) {
    // You can implement a toast notification here
    alert('✅ ' + message);
}

function showError(message) {
    // You can implement a toast notification here
    alert('❌ ' + message);
}
</script>
{% endblock %}
